## Sending log to Fluentd

This is a log line generated by `httpd`:
```
172.18.0.6 - - [16/Mar/2019:08:02:49 +0000] "GET / HTTP/1.1" 200 45
```

Then docker's fluentd logging driver sends it to fluentd server with following additional information:
- `tag` : `httpd.access`
- `container_id` : `d6a48ff9cfe611d563ef367c3558941edc6932d65d3a50108809f2434d3aedaa`
- `container_name` : `/docker-efk_web_1`
- `source` : `stdout`
- `@timestamp` : `2019-03-16T08:02:49.000000000+00:00`


## Transforming and sending log to ElasticSearch

After arriving, fluentd transforms and sends it to ElasticSearch under Logstash format.

With this fluentd's configuration:
```
logstash_format true
logstash_prefix fluentd
logstash_dateformat %Y%m%d
include_tag_key true
type_name access_log
tag_key @log_name
```

We'll get something like this being sent out to ElasticSearch:
```json
{
  "_index": "fluentd-20190316",
  "_type": "access_log",
  "_source": {
    "log": "172.18.0.6 - - [16/Mar/2019:08:02:49 +0000] \"GET / HTTP/1.1\" 200 45",
    "container_id": "d6a48ff9cfe611d563ef367c3558941edc6932d65d3a50108809f2434d3aedaa",
    "container_name": "/docker-efk_web_1",
    "source": "stdout",
    "@timestamp": "2019-03-16T08:02:49.000000000+00:00",
    "@log_name": "httpd.access"
  }
}
```

You can query the stored log with below query:
```json
{
  "query": {
    "match_all": {}
  },
  "from": 0,
  "size": 10
}
```

And here is the result:
```json
{
  "_index": "fluentd-20190316",
  "_type": "access_log",
  "_id": "hAmGhWkBZ2iuLbBHZtDr",
  "_score": 1,
  "_source": {
    "log": "172.18.0.6 - - [16/Mar/2019:08:02:49 +0000] \"GET / HTTP/1.1\" 200 45",
    "container_id": "d6a48ff9cfe611d563ef367c3558941edc6932d65d3a50108809f2434d3aedaa",
    "container_name": "/docker-efk_web_1",
    "source": "stdout",
    "@timestamp": "2019-03-16T08:02:49.000000000+00:00",
    "@log_name": "httpd.access"
  }
}
```

Additional information for `_index`, `_type`, `_id` and `_score` can be found here:
- https://www.elastic.co/guide/en/elasticsearch/guide/current/_document_metadata.html#_document_metadata
  - An index is a collection of documents that should be grouped together for a common reason.
  - Index name is specified by `_index` field.
- https://www.elastic.co/guide/en/elasticsearch/guide/current/_sorting.html#_sorting_by_field_values


## Viewing log on Kibana

Before viewing the log on Kibana, you have to define an index pattern.
- https://www.elastic.co/guide/en/kibana/current/tutorial-define-index.html
- Index patterns tell Kibana which Elasticsearch indices you want to explore.

And this is how the log looks like on Kibana:
```json
{
  "_index": "fluentd-20190316",
  "_type": "access_log",
  "_id": "hAmGhWkBZ2iuLbBHZtDr",
  "_version": 1,
  "_score": null,
  "_source": {
    "log": "172.18.0.6 - - [16/Mar/2019:08:02:49 +0000] \"GET / HTTP/1.1\" 200 45",
    "container_id": "d6a48ff9cfe611d563ef367c3558941edc6932d65d3a50108809f2434d3aedaa",
    "container_name": "/docker-efk_web_1",
    "source": "stdout",
    "@timestamp": "2019-03-16T08:02:49.000000000+00:00",
    "@log_name": "httpd.access"
  },
  "fields": {
    "@timestamp": [
      "2019-03-16T08:02:49.000Z"
    ]
  },
  "sort": [
    1552723369000
  ]
}
```


## About mappings

- https://www.elastic.co/guide/en/elasticsearch/guide/current/mapping-intro.html#_viewing_the_mapping

```json
{
  "fluentd-20190316": {
    "mappings": {
      "access_log": {
        "properties": {
          "@log_name": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "@timestamp": {
            "type": "date"
          },
          "container_id": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "container_name": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "log": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "message": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "source": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "worker": {
            "type": "long"
          }
        }
      }
    }
  }
}
```
